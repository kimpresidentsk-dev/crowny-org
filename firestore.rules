rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 기본: 모든 접근 차단
    match /{document=**} {
      allow read, write: if false;
    }

    // users - 본인 문서만 읽기/쓰기
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;

      match /wallets/{walletId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /contacts/{contactId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /friends/{friendId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /followers/{followerId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /following/{followingId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /savedPosts/{postId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /foundTreasures/{treasureId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // chats - 참가자만
    match /chats/{chatId} {
      allow read: if request.auth.uid in resource.data.participants;
      allow create: if request.auth != null;
      allow update: if request.auth.uid in resource.data.participants;

      match /messages/{msgId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
      }
    }

    // posts - 인증된 사용자 읽기, 본인만 수정/삭제
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.userId;

      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
      }
    }

    // products
    match /products/{productId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.sellerId;
    }

    // artworks
    match /artworks/{artworkId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.artistId;
    }

    // books
    match /books/{bookId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.authorId;
    }

    // campaigns
    match /campaigns/{campaignId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.creatorId;
    }

    // orders - 관련자만
    match /orders/{orderId} {
      allow read: if request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.sellerId;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.sellerId;
    }

    // transactions
    match /transactions/{txId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // notifications - 본인만
    match /notifications/{notifId} {
      allow read, write: if request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
    }

    // admin_config
    match /admin_config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // friend_requests
    match /friend_requests/{reqId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.to || request.auth.uid == resource.data.from;
    }

    // 기타 컬렉션 (translation_requests, book_translators 등)
    match /{collection}/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
    }
  }
}
