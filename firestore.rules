rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 기본: 모든 접근 차단
    match /{document=**} {
      allow read, write: if false;
    }

    // users - 본인 문서만 읽기/쓰기
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;

      match /wallets/{walletId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /contacts/{contactId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /friends/{friendId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /followers/{followerId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /following/{followingId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /savedPosts/{postId} {
        allow read, write: if request.auth.uid == userId;
      }
      match /foundTreasures/{treasureId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    // chats - 참가자만
    match /chats/{chatId} {
      allow read: if request.auth.uid in resource.data.participants;
      allow create: if request.auth != null;
      allow update: if request.auth.uid in resource.data.participants;

      match /messages/{msgId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
      }
    }

    // posts - 인증된 사용자 읽기, 본인만 수정/삭제
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.userId;

      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
      }
    }

    // products
    match /products/{productId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.sellerId;
    }

    // artworks
    match /artworks/{artworkId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.artistId;
    }

    // books
    match /books/{bookId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.authorId;
    }

    // campaigns
    match /campaigns/{campaignId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.creatorId;
    }

    // orders - 관련자만
    match /orders/{orderId} {
      allow read: if request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.sellerId;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.sellerId;
    }

    // transactions
    match /transactions/{txId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // notifications - 본인만
    match /notifications/{notifId} {
      allow read, write: if request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
    }

    // admin_config - 읽기는 모든 인증 사용자, 쓰기는 관리자만
    match /admin_config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.adminLevel >= 5;
    }

    // friend_requests
    match /friend_requests/{reqId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.to || request.auth.uid == resource.data.from;
    }

    // shortform_videos
    match /shortform_videos/{videoId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.uid;

      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
      }
    }

    // offchain_transactions
    match /offchain_transactions/{txId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // care_groups
    match /care_groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;

      match /{subcol}/{docId} {
        allow read, write: if request.auth != null;
      }
    }

    // sos_alerts
    match /sos_alerts/{alertId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;

      match /locations/{locId} {
        allow read, write: if request.auth != null;
      }
    }

    // social_notifications
    match /social_notifications/{notifId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }

    // channels (group chat)
    match /channels/{channelId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;

      match /messages/{msgId} {
        allow read, write: if request.auth != null;
      }
    }

    // trading participants
    match /challenges/{challengeId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;

      match /participants/{participantId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // translation_requests, book_translators 등 기타
    match /translation_requests/{docId} {
      allow read, create: if request.auth != null;
    }
    match /book_translators/{docId} {
      allow read, create: if request.auth != null;
    }
    match /donations/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }
    match /reviews/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
    }
    match /reports/{docId} {
      allow create: if request.auth != null;
    }
  }
}
